<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- ... предыдущий код без изменений ... -->
    <style>
        /* ... предыдущие стили без изменений ... */
    </style>
</head>
<body>
    <!-- ... предыдущая разметка без изменений ... -->

    <script>
        // ==================== КОНФИГУРАЦИЯ ====================
        const CONFIG = {
            webhookUrl: 'https://bessonov-test.ru/webhook/veridia-webhook',
            sessionId: null,
            userId: `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            userName: 'Гость',
            maxMessageLength: 2000,
            autoSaveInterval: 30000,
            showWelcomeModal: true
        };

        // ==================== ЭЛЕМЕНТЫ DOM ====================
        const elements = {
            messagesContainer: document.getElementById('messagesContainer'),
            messageInput: document.getElementById('messageInput'),
            sendButton: document.getElementById('sendButton'),
            typingIndicator: document.getElementById('typingIndicator'),
            progressContainer: document.getElementById('progressContainer'),
            progressName: document.getElementById('progressName'),
            progressPhone: document.getElementById('progressPhone'),
            progressEmail: document.getElementById('progressEmail'),
            progressProject: document.getElementById('progressProject'),
            welcomeModal: document.getElementById('welcomeModal'),
            privacyModal: document.getElementById('privacyModal'),
            privacyCheckbox: document.getElementById('privacyCheckbox'),
            privacyAgreement: document.getElementById('privacyAgreement'),
            charCount: document.getElementById('charCount'),
            initTime: document.getElementById('initTime'),
            connectionStatus: document.getElementById('connectionStatus')
        };

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', () => {
            elements.initTime.textContent = getCurrentTime();
            setupMessageInput();
            setupSendButton();
            restoreSession();
            checkPrivacyAgreement();
            startAutoSave();
            focusInput();
            
            // ИСПРАВЛЕНИЕ: Загружаем прогресс из сохраненной сессии
            const savedSession = getSessionData();
            if (savedSession && savedSession.collected_data) {
                updateProgressIndicator({
                    collected_data: savedSession.collected_data,
                    missing_fields: savedSession.missing_fields || {}
                });
            }
        });

        // ==================== ФУНКЦИИ УТИЛИТЫ ====================
        function getCurrentTime() {
            const now = new Date();
            return now.getHours().toString().padStart(2, '0') + ':' + 
                   now.getMinutes().toString().padStart(2, '0');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatMessage(text) {
            return escapeHtml(text)
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>');
        }

        function setCookie(name, value, days) {
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${date.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                const [cookieName, cookieValue] = cookie.trim().split('=');
                if (cookieName === name) return cookieValue;
            }
            return null;
        }

        // ==================== НАСТРОЙКА КНОПКИ ОТПРАВКИ ====================
        function setupSendButton() {
            elements.sendButton.addEventListener('click', sendMessage);
        }

        // ==================== УПРАВЛЕНИЕ ЧАТОМ ====================
        function addMessage(text, sender = 'assistant', data = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const time = getCurrentTime();
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="avatar">В</div>
                        <div class="sender-info">
                            <div class="sender-name">Вы</div>
                        </div>
                    </div>
                    <div class="message-content">${formatMessage(text)}</div>
                    <div class="message-time">${time}</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-header">
                        <div class="avatar">А</div>
                        <div class="sender-info">
                            <div class="sender-name">Алексей</div>
                        </div>
                    </div>
                    <div class="message-content">${formatMessage(text)}</div>
                    <div class="message-time">${time}</div>
                `;
            }
            
            elements.messagesContainer.appendChild(messageDiv);
            scrollToBottom();
            
            if (data) {
                updateProgressIndicator(data);
            }
            
            saveMessageToHistory(text, sender, time, data);
        }

        // ==================== ИСПРАВЛЕННАЯ ФУНКЦИЯ ОБНОВЛЕНИЯ ПРОГРЕССА ====================
        function updateProgressIndicator(data) {
            console.log('Обновление прогресса:', data);
            
            if (!data) return;
            
            // Получаем данные из разных мест ответа
            let collectedData = {};
            let missingFields = {};
            
            if (data.collected_data) {
                collectedData = data.collected_data;
            } else if (data.session_data && data.session_data.collected_data) {
                collectedData = data.session_data.collected_data;
            }
            
            if (data.missing_fields) {
                missingFields = data.missing_fields;
            }
            
            // Если есть какие-то данные - показываем прогресс
            if (Object.keys(collectedData).length > 0) {
                elements.progressContainer.classList.remove('hidden');
                
                // Обновляем каждый элемент прогресса
                const updateProgressItem = (itemId, fieldName, displayName) => {
                    const element = document.getElementById(itemId);
                    if (element) {
                        const icon = element.querySelector('.progress-icon');
                        const text = element.querySelector('.progress-text');
                        
                        const value = collectedData[fieldName] || '';
                        const hasValue = value && value.trim() !== '' && value !== 'Гость';
                        
                        if (hasValue) {
                            icon.className = 'progress-icon completed';
                            icon.innerHTML = `<i class="fas fa-check"></i>`;
                            text.className = 'progress-text completed';
                            // Показываем только первую часть значения (для приватности)
                            const displayValue = fieldName === 'phone' || fieldName === 'email' 
                                ? 'указан' + (fieldName === 'email' ? 'а' : '')
                                : value;
                            text.textContent = `${displayName}: ${displayValue}`;
                        } else {
                            icon.className = 'progress-icon pending';
                            icon.innerHTML = `<i class="fas fa-${fieldName === 'name' ? 'user' : fieldName === 'phone' ? 'phone' : fieldName === 'email' ? 'envelope' : 'building'}"></i>`;
                            text.className = 'progress-text';
                            text.textContent = `${displayName}: не указан${fieldName === 'email' ? 'а' : 'о'}`;
                        }
                    }
                };
                
                // Обновляем все элементы
                updateProgressItem('progressName', 'name', 'Имя');
                updateProgressItem('progressPhone', 'phone', 'Телефон');
                updateProgressItem('progressEmail', 'email', 'Email');
                updateProgressItem('progressProject', 'project_type', 'Тип проекта');
                
                // Сохраняем данные в сессию
                const savedSession = getSessionData() || {};
                savedSession.collected_data = collectedData;
                savedSession.missing_fields = missingFields;
                saveSessionData(savedSession);
            }
        }

        function scrollToBottom() {
            requestAnimationFrame(() => {
                elements.messagesContainer.scrollTop = elements.messagesContainer.scrollHeight;
            });
        }

        // ==================== ВВОД СООБЩЕНИЙ ====================
        function setupMessageInput() {
            elements.messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 160) + 'px';
                elements.charCount.textContent = this.value.length;
            });
            
            elements.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            elements.messagesContainer.addEventListener('click', focusInput);
        }

        function focusInput() {
            elements.messageInput.focus();
        }

        // ==================== ОТПРАВКА СООБЩЕНИЙ (ИСПРАВЛЕННАЯ) ====================
        async function sendMessage() {
            if (!elements.privacyCheckbox.checked) {
                alert('Для отправки сообщения необходимо согласиться с Политикой конфиденциальности');
                elements.privacyCheckbox.focus();
                return;
            }
            
            const message = elements.messageInput.value.trim();
            if (!message || message.length > CONFIG.maxMessageLength) {
                return;
            }
            
            elements.sendButton.disabled = true;
            elements.messageInput.disabled = true;
            
            addMessage(message, 'user');
            elements.messageInput.value = '';
            elements.messageInput.style.height = '56px';
            elements.charCount.textContent = '0';
            
            elements.typingIndicator.classList.add('active');
            scrollToBottom();
            
            try {
                const sessionData = getSessionData() || {};
                
                // ИСПРАВЛЕНИЕ: Правильно формируем данные для отправки
                const requestData = {
                    message: message,
                    user_id: sessionData.user_id || CONFIG.userId,
                    session_id: sessionData.session_id || CONFIG.sessionId,
                    name: sessionData.user_name || CONFIG.userName,
                    session_data: sessionData,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Отправка запроса на:', CONFIG.webhookUrl);
                console.log('Данные запроса:', requestData);
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000);
                
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    signal: controller.signal,
                    mode: 'cors'
                });
                
                clearTimeout(timeoutId);
                
                console.log('Статус ответа:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Ошибка сервера:', errorText);
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                const responseText = await response.text();
                console.log('Ответ сервера (текст):', responseText);
                
                // ИСПРАВЛЕНИЕ: Проверяем, что ответ не пустой
                if (!responseText || responseText.trim() === '') {
                    console.warn('Пустой ответ от сервера');
                    throw new Error('Пустой ответ от сервера');
                }
                
                let result;
                try {
                    result = JSON.parse(responseText);
                    console.log('Ответ сервера (JSON):', result);
                } catch (e) {
                    console.error('Ошибка парсинга JSON:', e);
                    console.error('Ответ, вызвавший ошибку:', responseText);
                    throw new Error(`Некорректный JSON: ${responseText.substring(0, 100)}`);
                }
                
                let aiResponse = '';
                let responseData = {};
                
                if (result && result.body) {
                    aiResponse = result.body.text || result.body.message || 'Принято';
                    responseData = result.body;
                    
                    if (result.body.session_id) {
                        CONFIG.sessionId = result.body.session_id;
                        console.log('Session ID установлен:', CONFIG.sessionId);
                        
                        // Сохраняем в sessionData
                        sessionData.session_id = CONFIG.sessionId;
                        if (result.body.user_name && result.body.user_name !== 'Гость') {
                            sessionData.user_name = result.body.user_name;
                            CONFIG.userName = result.body.user_name;
                        }
                        saveSessionData(sessionData);
                    }
                } else {
                    aiResponse = 'Принято. Чем еще могу помочь?';
                }
                
                // Сохраняем обновленные данные сессии
                if (responseData.session_id) {
                    sessionData.session_id = responseData.session_id;
                }
                if (responseData.user_name && responseData.user_name !== 'Гость') {
                    sessionData.user_name = responseData.user_name;
                    CONFIG.userName = responseData.user_name;
                }
                if (responseData.collected_data) {
                    sessionData.collected_data = responseData.collected_data;
                }
                if (responseData.missing_fields) {
                    sessionData.missing_fields = responseData.missing_fields;
                }
                
                saveSessionData(sessionData);
                
                addMessage(aiResponse, 'assistant', responseData);
                
                if (responseData.continue_conversation === false) {
                    disableChatInput('Диалог завершен. Спасибо за обращение!');
                } else {
                    elements.sendButton.disabled = false;
                    elements.messageInput.disabled = false;
                    focusInput();
                }
                
            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                
                let errorMessage = '⚠️ **Произошла ошибка**<br>';
                
                if (error.name === 'AbortError') {
                    errorMessage += 'Таймаут запроса (30 сек). Сервер не отвечает.<br>';
                    errorMessage += 'Возможно, n8n workflow занят или завершился с ошибкой.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
                    errorMessage += 'Проверьте подключение к интернету и доступность сервера.';
                } else if (error.message.includes('Пустой ответ') || error.message.includes('Unexpected end')) {
                    errorMessage += 'Сервер вернул пустой ответ.<br>';
                    errorMessage += 'Проверьте логи n8n и убедитесь, что workflow активирован.';
                } else if (error.message.includes('Некорректный JSON')) {
                    errorMessage += 'Сервер вернул некорректный ответ.<br>';
                    errorMessage += 'Проверьте консоль n8n на наличие ошибок.';
                } else {
                    errorMessage += error.message || 'Неизвестная ошибка';
                }
                
                addMessage(errorMessage, 'assistant');
                
                elements.sendButton.disabled = false;
                elements.messageInput.disabled = false;
                focusInput();
                
            } finally {
                elements.typingIndicator.classList.remove('active');
            }
        }

        function disableChatInput(placeholder = 'Диалог завершен') {
            elements.messageInput.disabled = true;
            elements.sendButton.disabled = true;
            elements.messageInput.placeholder = placeholder;
        }

        // ==================== УПРАВЛЕНИЕ СЕССИЕЙ ====================
        function getSessionData() {
            try {
                const saved = localStorage.getItem('veridia_chat_session');
                return saved ? JSON.parse(saved) : {};
            } catch (error) {
                console.error('Ошибка чтения сессии:', error);
                return {};
            }
        }

        function saveSessionData(data) {
            try {
                const session = {
                    ...data,
                    session_id: data.session_id || CONFIG.sessionId,
                    user_id: data.user_id || CONFIG.userId,
                    user_name: data.user_name || CONFIG.userName,
                    last_updated: new Date().toISOString()
                };
            
                localStorage.setItem('veridia_chat_session', JSON.stringify(session));
                console.log('Сессия сохранена:', session);
            } catch (error) {
                console.error('Ошибка сохранения сессии:', error);
            }
        }

        function saveMessageToHistory(text, sender, time, data) {
            try {
                const history = JSON.parse(localStorage.getItem('veridia_chat_history') || '[]');
                history.push({
                    text,
                    sender,
                    time,
                    data,
                    timestamp: new Date().toISOString()
                });
            
                localStorage.setItem('veridia_chat_history', JSON.stringify(history.slice(-50)));
            } catch (error) {
                console.error('Ошибка сохранения истории:', error);
            }
        }

        function restoreSession() {
            try {
                const savedSession = getSessionData();
            
                if (savedSession && savedSession.session_id) {
                    CONFIG.sessionId = savedSession.session_id;
                    CONFIG.userId = savedSession.user_id || CONFIG.userId;
                    CONFIG.userName = savedSession.user_name || CONFIG.userName;
                
                    console.log('Сессия восстановлена:', {
                        sessionId: CONFIG.sessionId,
                        userId: CONFIG.userId,
                        userName: CONFIG.userName
                    });
                
                    if (savedSession.collected_data) {
                        updateProgressIndicator({
                            collected_data: savedSession.collected_data,
                            missing_fields: savedSession.missing_fields || {}
                        });
                    }
                
                    if (savedSession.continue_conversation === false) {
                        disableChatInput('Предыдущий диалог завершен. Начните новый.');
                    }
                }
            } catch (error) {
                console.error('Ошибка восстановления сессии:', error);
            }
        }

        function startAutoSave() {
            setInterval(() => {
                if (CONFIG.sessionId) {
                    const sessionData = getSessionData() || {};
                    sessionData.last_activity = new Date().toISOString();
                    sessionData.session_id = CONFIG.sessionId;
                    sessionData.user_id = CONFIG.userId;
                    sessionData.user_name = CONFIG.userName;
                    saveSessionData(sessionData);
                }
            }, CONFIG.autoSaveInterval);
        }

        function checkPrivacyAgreement() {
            const privacyAgreed = getCookie('privacyAgreed') === 'true';
            if (privacyAgreed) {
                elements.privacyCheckbox.checked = true;
            }
            
            const welcomeShown = getCookie('welcomeModalShown') === 'true';
            if (!welcomeShown) {
                elements.welcomeModal.classList.remove('hidden');
            }
        }

        // ==================== ДОПОЛНИТЕЛЬНЫЕ ФУНКЦИИ ====================
        function clearChat() {
            if (!confirm('Вы уверены, что хотите очистить историю чата? Это действие нельзя отменить.')) {
                return;
            }
        
            const messages = elements.messagesContainer.querySelectorAll('.message');
            messages.forEach((msg, index) => {
                if (index > 0) msg.remove();
            });
        
            localStorage.removeItem('veridia_chat_history');
            localStorage.removeItem('veridia_chat_session');
        
            CONFIG.sessionId = null;
            CONFIG.userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            CONFIG.userName = 'Гость';
        
            elements.progressContainer.classList.add('hidden');
            elements.messageInput.disabled = false;
            elements.sendButton.disabled = false;
            elements.messageInput.placeholder = 'Напишите ваш вопрос о строительной документации...';
        
            focusInput();
        
            addMessage('История чата была очищена. Теперь начнем новый диалог. Расскажите о вашем проекте.', 'assistant');
        }

        function closeWelcomeModal() {
            elements.welcomeModal.classList.add('hidden');
            setCookie('welcomeModalShown', 'true', 7);
            focusInput();
        }

        function startChat() {
            elements.welcomeModal.classList.add('hidden');
            setCookie('welcomeModalShown', 'true', 7);
            focusInput();
        
            setTimeout(() => {
                addMessage(
                    'Отлично! Теперь вы можете задать любой вопрос о строительной документации. ' +
                    'Для начала расскажите кратко о вашем объекте — это промышленное здание, склад, ' +
                    'офисный центр или другой тип объекта?',
                    'assistant'
                );
            }, 500);
        }

        function showPrivacyModal(event) {
            if (event) event.preventDefault();
            elements.privacyModal.classList.remove('hidden');
        }

        function closePrivacyModal() {
            elements.privacyModal.classList.add('hidden');
        
            if (!elements.privacyCheckbox.checked) {
                elements.privacyCheckbox.checked = true;
                setCookie('privacyAgreed', 'true', 365);
            }
        }

        // ==================== ЭКСПОРТ ФУНКЦИЙ ====================
        window.sendMessage = sendMessage;
        window.clearChat = clearChat;
        window.closeWelcomeModal = closeWelcomeModal;
        window.startChat = startChat;
        window.showPrivacyModal = showPrivacyModal;
        window.closePrivacyModal = closePrivacyModal;
    </script>
</body>
</html>
