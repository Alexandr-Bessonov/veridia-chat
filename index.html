<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат Веридиа</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .chat-container { max-width: 800px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #003DA6; color: white; padding: 15px; border-radius: 10px 10px 0 0; }
        .messages { height: 500px; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; max-width: 70%; }
        .user { background: #003DA6; color: white; margin-left: auto; }
        .assistant { background: #f0f0f0; margin-right: auto; }
        .input-area { padding: 15px; border-top: 1px solid #ddd; display: flex; }
        input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button { background: #003DA6; color: white; border: none; padding: 10px 20px; margin-left: 10px; border-radius: 5px; cursor: pointer; }
        button:disabled { background: #ccc; }
        .progress { padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd; }
        .progress-item { display: inline-block; margin-right: 20px; }
        .progress-item.completed { color: green; font-weight: bold; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="header">
            <h2>ИИ-агент Веридиа</h2>
            <p>Алексей • Эксперт по инженерной документации</p>
        </div>
        
        <div class="progress" id="progress">
            <div class="progress-item" id="nameItem">Имя: ❌</div>
            <div class="progress-item" id="phoneItem">Телефон: ❌</div>
            <div class="progress-item" id="emailItem">Email: ❌</div>
            <div class="progress-item" id="projectItem">Проект: ❌</div>
        </div>
        
        <div class="messages" id="messages">
            <div class="message assistant">
                <strong>Здравствуйте! Я Алексей, ведущий эксперт компании «ВЕРИДИА».</strong><br><br>
                Специализируюсь на инженерном сопровождении строительства и подготовке 
                исполнительной документации. Готов помочь с вашим проектом и провести 
                бесплатный экспресс-аудит документации.<br><br>
                <em>Расскажите, пожалуйста, о вашем объекте.</em>
            </div>
        </div>
        
        <div class="input-area">
            <input type="text" id="messageInput" placeholder="Напишите сообщение..." onkeypress="if(event.key=='Enter') sendMessage()">
            <button id="sendButton" onclick="sendMessage()">Отправить</button>
        </div>
    </div>

    <script>
        // ==================== ПРОСТАЯ КОНФИГУРАЦИЯ ====================
        const CONFIG = {
            webhookUrl: 'https://bessonov-test.ru/webhook/veridia-webhook',
            sessionId: localStorage.getItem('session_id') || 'session_' + Date.now(),
            userId: localStorage.getItem('user_id') || 'user_' + Date.now()
        };

        // ==================== СОХРАНЕНИЕ ДАННЫХ ====================
        let collectedData = {
            name: localStorage.getItem('user_name') || '',
            phone: localStorage.getItem('user_phone') || '',
            email: localStorage.getItem('user_email') || '',
            project_type: localStorage.getItem('project_type') || ''
        };

        // ==================== ОБНОВЛЕНИЕ ПРОГРЕССА ====================
        function updateProgress() {
            const items = ['nameItem', 'phoneItem', 'emailItem', 'projectItem'];
            const fields = ['name', 'phone', 'email', 'project_type'];
            
            fields.forEach((field, index) => {
                const element = document.getElementById(items[index]);
                if (collectedData[field]) {
                    element.innerHTML = element.innerHTML.split(':')[0] + ': ✅';
                    element.className = 'progress-item completed';
                } else {
                    element.innerHTML = element.innerHTML.split(':')[0] + ': ❌';
                    element.className = 'progress-item';
                }
            });
        }

        // ==================== ДОБАВЛЕНИЕ СООБЩЕНИЙ ====================
        function addMessage(text, isUser = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            messageDiv.innerHTML = text;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // ==================== ИЗВЛЕЧЕНИЕ ДАННЫХ ====================
        function extractDataFromMessage(message) {
            // Извлечение телефона
            const phoneMatch = message.match(/(?:\+7|8|7)[\s\-]?\(?\d{3}\)?[\s\-]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}/);
            if (phoneMatch && !collectedData.phone) {
                collectedData.phone = phoneMatch[0];
                localStorage.setItem('user_phone', collectedData.phone);
            }

            // Извлечение email
            const emailMatch = message.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
            if (emailMatch && !collectedData.email) {
                collectedData.email = emailMatch[0];
                localStorage.setItem('user_email', collectedData.email);
            }

            // Извлечение имени
            const nameMatch = message.match(/(?:зовут|имя|меня зовут)[\s:]*([А-ЯЁ][а-яё]+)/i);
            if (nameMatch && nameMatch[1] && !collectedData.name) {
                collectedData.name = nameMatch[1];
                localStorage.setItem('user_name', collectedData.name);
            }

            // Извлечение типа проекта
            if (!collectedData.project_type) {
                if (message.toLowerCase().includes('промышлен') || message.includes('завод')) {
                    collectedData.project_type = 'Промышленный объект';
                } else if (message.toLowerCase().includes('склад')) {
                    collectedData.project_type = 'Складской комплекс';
                } else if (message.toLowerCase().includes('офис')) {
                    collectedData.project_type = 'Офисное здание';
                }
                if (collectedData.project_type) {
                    localStorage.setItem('project_type', collectedData.project_type);
                }
            }

            updateProgress();
        }

        // ==================== ОТПРАВКА СООБЩЕНИЯ ====================
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const button = document.getElementById('sendButton');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Блокируем интерфейс
            input.value = '';
            input.disabled = true;
            button.disabled = true;
            
            // Показываем сообщение пользователя
            addMessage(message, true);
            
            // Извлекаем данные из сообщения
            extractDataFromMessage(message);
            
            // Формируем данные для отправки
            const requestData = {
                message: message,
                user_id: CONFIG.userId,
                session_id: CONFIG.sessionId,
                name: collectedData.name || 'Гость',
                session_data: {
                    collected_data: collectedData,
                    conversation_length: parseInt(localStorage.getItem('conversation_length') || '0') + 1
                },
                timestamp: new Date().toISOString()
            };
            
            // Сохраняем длину диалога
            localStorage.setItem('conversation_length', requestData.session_data.conversation_length);
            localStorage.setItem('session_id', CONFIG.sessionId);
            localStorage.setItem('user_id', CONFIG.userId);
            
            console.log('Отправляю данные на сервер:', requestData);
            
            try {
                // Отправляем на сервер
                const response = await fetch(CONFIG.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestData),
                    mode: 'cors'
                });
                
                console.log('Статус ответа:', response.status);
                
                const responseText = await response.text();
                console.log('Ответ сервера:', responseText);
                
                let aiResponse = '';
                
                if (responseText && responseText.trim() !== '') {
                    try {
                        const result = JSON.parse(responseText);
                        console.log('Парсинг JSON успешен:', result);
                        
                        if (result && result.body && result.body.text) {
                            aiResponse = result.body.text;
                            
                            // Обновляем данные из ответа сервера
                            if (result.body.collected_data) {
                                collectedData = { ...collectedData, ...result.body.collected_data };
                                Object.keys(collectedData).forEach(key => {
                                    if (collectedData[key]) {
                                        localStorage.setItem(`user_${key}`, collectedData[key]);
                                    }
                                });
                                updateProgress();
                            }
                            
                            // Сохраняем session_id
                            if (result.body.session_id) {
                                CONFIG.sessionId = result.body.session_id;
                                localStorage.setItem('session_id', CONFIG.sessionId);
                            }
                        } else {
                            throw new Error('Некорректная структура ответа');
                        }
                    } catch (parseError) {
                        console.error('Ошибка парсинга JSON:', parseError);
                        aiResponse = generateLocalResponse();
                    }
                } else {
                    console.warn('Пустой ответ от сервера');
                    aiResponse = generateLocalResponse();
                }
                
                addMessage(aiResponse, false);
                
            } catch (error) {
                console.error('Ошибка отправки:', error);
                addMessage(generateLocalResponse(), false);
            }
            
            // Разблокируем интерфейс
            input.disabled = false;
            button.disabled = false;
            input.focus();
        }

        // ==================== ЛОКАЛЬНЫЙ ОТВЕТ (если сервер не отвечает) ====================
        function generateLocalResponse() {
            if (!collectedData.name) {
                return "Привет! Меня зовут Алексей. Для начала представьтесь, пожалуйста. Как вас зовут?";
            } else if (!collectedData.phone) {
                return `Приятно познакомиться, ${collectedData.name}! Какой у вас номер телефона для связи?`;
            } else if (!collectedData.email) {
                return `Спасибо! Телефон записан. Какой у вас email для отправки документов?`;
            } else if (!collectedData.project_type) {
                return "Отлично! И последний вопрос: какой у вас тип проекта? (промышленный, складской, офисный и т.д.)";
            } else {
                return `✅ Спасибо, ${collectedData.name}! Все данные собраны. Наш менеджер свяжется с вами по телефону ${collectedData.phone} в ближайшее время.`;
            }
        }

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', () => {
            updateProgress();
            document.getElementById('messageInput').focus();
            
            // Тестовый запрос для проверки соединения
            console.log('Проверяю соединение с сервером...');
            fetch(CONFIG.webhookUrl, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({test: true})
            }).then(response => {
                console.log('Сервер доступен, статус:', response.status);
            }).catch(error => {
                console.warn('Сервер недоступен, используем локальные ответы:', error);
            });
        });
    </script>
</body>
</html>
